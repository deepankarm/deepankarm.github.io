<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><title>Jina ü§ù Linkerd | Deepankar's Tech Blogs</title><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/font.css><link rel=stylesheet href=/css/smigle.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><header><div id=brand><a class=icon-link href=http://deepankarm.github.io/><img class=icon src=/images/brandIcon.svg></a><div class=text><a href=http://deepankarm.github.io/><h1>Deepankar's Tech Blogs</h1></a><h3>Engineering Manager - Jina AI</h3></div></div><nav><a href=/><b>Home</b></a>
|
<a href=/about/><b>About</b></a>
|
<a href=/posts/><b>Posts</b></a></nav><hr></header><div id=content><main><article><h1>Jina ü§ù Linkerd</h1><div class=post-meta><strong><span>Posted on</span>
<time>2022-06-16 12:49:55</time></strong>
<span>‚Ä¢ 1299 words</span>
<span>‚Ä¢ 7 minute read</span><div><span>Tags:</span>
<a href=/tags/jina>jina</a>,
<a href=/tags/service-mesh>service-mesh</a>,
<a href=/tags/linkerd>linkerd</a>,
<a href=/tags/kubernetes>kubernetes</a></div></div><div><p>Let&rsquo;s discuss today about a way to debug your Executors & Flows using Linkerd service mesh.</p><hr><h2 id=what-is-a-service-mesh>What is a Service Mesh?</h2><p>From Linkerd <a href=https://buoyant.io/service-mesh-manifesto/>docs</a></p><blockquote><p>A service mesh is a tool for adding observability, security, and reliability features to ‚Äúcloud native‚Äù applications by transparently inserting this functionality at the platform layer rather than the application layer.</p></blockquote><p>Few of the commonly used service meshes are Linkerd, Istio, Consul etc.</p><hr><h2 id=why-linkerd>Why Linkerd?</h2><ul><li>Significantly lighter than competitors.</li><li>Basic request tracing with no additional config.</li><li>Telemetry & monitoring exposing <a href=https://linkerd.io/2.11/features/telemetry/#golden-metrics>Golden metrics</a>.</li><li>The simplicity of its usage is mind-blowing. Just annotate the K8S Deployment, and you&rsquo;re done.</li></ul><hr><h2 id=how-does-linkerd-work>How does Linkerd work?</h2><p>While this majorly underestimates the magic Linkerd brings, here are the major components. Feel free to go through the architecture in <a href=https://linkerd.io/2.11/reference/architecture/>official docs</a>.</p><p align=center><a href=https://linkerd.io/2.11/reference/architecture/><img src=/images/jina-linkerd/linkerd-control-plane.png alt="Linkerd architecture" width=80%></a></p><h4 id=data-plane>Data Plane</h4><p>This sits next to your application (K8S Pod), hence called the data plane.</p><ol><li><a href=https://linkerd.io/2.11/reference/architecture/#proxy>linkerd-proxy</a>: A sidecar container next to your Pod via which all traffic goes in & out.</li><li><a href=https://linkerd.io/2.11/reference/architecture/#linkerd-init-container>linkerd-init</a>: An init container in the Pod to configure the iptables so traffic flows through the proxy.</li></ol><h4 id=control-plane>Control Plane</h4><p>This sits in a different namespace (<code>linkerd</code> by default).</p><ol><li><a href=https://linkerd.io/2.11/reference/architecture/#the-destination-service>destination</a>: Informs the linkerd-proxy about routing & TLS at destination.</li><li><a href=https://linkerd.io/2.11/reference/architecture/#the-identity-service>identity</a>: Manages TLS certificates for proxy-to-proxy mutual TLS.</li><li><a href=https://linkerd.io/2.11/reference/architecture/#the-proxy-injector>proxy-injector</a>: Adds the data-plane Pods to your Deployment.</li></ol><hr><h2 id=jina--linkerd>Jina & Linkerd</h2><h4 id=installation>Installation</h4><p>Follow the official docs to install Linkerd CLI, Control plane & the dashboard on your cluster.</p><p>üëâ <a href=https://linkerd.io/2.11/getting-started/>Linkerd Getting started</a></p><h4 id=annotations-in-flow-related-k8s-yamls>Annotations in Flow related K8S yamls</h4><p>By default, when we <a href=https://docs.jina.ai/fundamentals/flow/create-flow/#kubernetes>export K8S yamls from a Flow</a>, jina adds all linkerd annotations.</p><p align=center><a href=#><img src=/images/jina-linkerd/annotation.png alt="Linkerd annotation" width=50%></a></p><p>Applying the K8S yamls adds the linkerd-proxy container to your Pod (Note 2 containers per Pod)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -R -f flowdir/
</span></span><span style=display:flex><span>$ kubectl get pods -n &lt;namespace&gt;
</span></span><span style=display:flex><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>embeddingsfilter-8598855df4-bp54j          2/2     Running   <span style=color:#ae81ff>0</span>          100m
</span></span><span style=display:flex><span>gateway-8b45c579c-c9bcb                    2/2     Running   <span style=color:#ae81ff>0</span>          100m
</span></span><span style=display:flex><span>pqliteindexer-58c7dc7986-jlnnz             2/2     Running   <span style=color:#ae81ff>0</span>          100m
</span></span><span style=display:flex><span>transformertorchencoder-6d9875f575-jrx45   2/2     Running   <span style=color:#ae81ff>0</span>          100m
</span></span></code></pre></div><p>To tail the logs of the executor, you must pass the container name (<code>executor</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl logs gateway-8b45c579c-c9bcb -n &lt;namespace&gt; -f
</span></span><span style=display:flex><span>error: a container name must be specified <span style=color:#66d9ef>for</span> pod gateway-8b45c579c-c9bcb, choose one of: <span style=color:#f92672>[</span>linkerd-proxy executor<span style=color:#f92672>]</span> or one of the init containers: <span style=color:#f92672>[</span>linkerd-init<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl logs gateway-8b45c579c-c9bcb executor -n &lt;namespace&gt; -f
</span></span><span style=display:flex><span>INFO:     127.0.0.1:35370 - <span style=color:#e6db74>&#34;POST /post HTTP/1.1&#34;</span> <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>INFO:     127.0.0.1:35372 - <span style=color:#e6db74>&#34;POST /post HTTP/1.1&#34;</span> <span style=color:#ae81ff>200</span> OK
</span></span></code></pre></div><h4 id=explore-the-dashboard>Explore the dashboard</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd viz dashboard &amp;
</span></span></code></pre></div><p>Note the &ldquo;Meshed&rdquo; section for our namespace. All 4 Pods are meshed (include the &ldquo;linkerd-proxy&rdquo; container).</p><p align=center><img src=/images/jina-linkerd/dashboard.png alt="Linkerd dashboard" width=80%></p><p>That&rsquo;s it. It is that simple to integrate a service mesh & get the benefits such as mTLS, latency aware load-balancing, basic request tracing, easier retries & timeouts etc.</p><hr><h2 id=lets-build--debug-an-application>Let&rsquo;s build & debug an application</h2><h4 id=define--publish-an-executor>Define & publish an Executor</h4><p>For demo purpose, I created a &ldquo;dummy&rdquo; heavy Executor. Depending on the arguments passed, it&rsquo;d sleep for some time or, add embeddings to the DocumentArray. This can be any of the heavy Executors in <a href=hub.jina.ai>Hub</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> jina <span style=color:#f92672>import</span> DocumentArray, Executor, requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HeavyExecutorLinkerdDemo</span>(Executor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, n_dim: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>256</span>, sleep: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>__init__(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>n_dim <span style=color:#f92672>=</span> n_dim
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sleep <span style=color:#f92672>=</span> sleep
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@requests</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>(self, docs: DocumentArray, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(self<span style=color:#f92672>.</span>sleep)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>n_dim <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>            docs<span style=color:#f92672>.</span>embeddings <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>random<span style=color:#f92672>.</span>random([len(docs), self<span style=color:#f92672>.</span>n_dim])
</span></span></code></pre></div><p>It is already pushed to <a href=https://hub.jina.ai/executor/qgy74myk>Hub</a> and can be used with <code>jinahub://HeavyExecutorLinkerdDemo</code> syntax.</p><hr><h4 id=define--deploy-the-flow>Define & deploy the Flow</h4><p>Now, let&rsquo;s define a Flow with 2 Executors</p><ul><li>&ldquo;slow_executor&rdquo;: Sleeps for 1 sec per request</li><li>&ldquo;bulky_executor&rdquo;: Adds a random embedding to each Document in the DA</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>jtype</span>: <span style=color:#ae81ff>Flow</span>
</span></span><span style=display:flex><span><span style=color:#f92672>executors</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># A slow Executor</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># sleeps 1 secs per request</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>slow_executor</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>jinahub+docker://HeavyExecutorLinkerdDemo</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses_with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>n_dim</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sleep</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># A bulky Executor</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Adds a 512 dim embedding to each Document in the DA</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bulky_executor</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>jinahub+docker://HeavyExecutorLinkerdDemo</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses_with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>n_dim</span>: <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sleep</span>: <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>We can export K8S yamls from this Flow, apply them, wait for the Pods to start & expose the Gateway using &ldquo;port-forward&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ jina export kubernetes flow.yml demo-linkerd --k8s-namespace demo-linkerd
</span></span><span style=display:flex><span>$ kubectl create namespace demo-linkerd
</span></span><span style=display:flex><span>$ kubectl apply -R -f demo-linkerd/
</span></span><span style=display:flex><span>$ kubectl get pods -n demo-linkerd -w
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                             READY   STATUS            RESTARTS   AGE
</span></span><span style=display:flex><span>fast-executor-5b5b68d449-l6nwf   0/2     PodInitializing   <span style=color:#ae81ff>0</span>          18s
</span></span><span style=display:flex><span>gateway-c549bf99c-q2dpd          2/2     Running           <span style=color:#ae81ff>0</span>          18s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-bx586   0/2     PodInitializing   <span style=color:#ae81ff>0</span>          18s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-sc7h6   0/2     PodInitializing   <span style=color:#ae81ff>0</span>          18s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-bx586   0/2     Running           <span style=color:#ae81ff>0</span>          20s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-bx586   1/2     Running           <span style=color:#ae81ff>0</span>          20s
</span></span><span style=display:flex><span>fast-executor-5b5b68d449-l6nwf   0/2     Running           <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>fast-executor-5b5b68d449-l6nwf   1/2     Running           <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-sc7h6   0/2     Running           <span style=color:#ae81ff>0</span>          25s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-sc7h6   1/2     Running           <span style=color:#ae81ff>0</span>          25s
</span></span><span style=display:flex><span>fast-executor-5b5b68d449-l6nwf   2/2     Running           <span style=color:#ae81ff>0</span>          30s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-sc7h6   2/2     Running           <span style=color:#ae81ff>0</span>          30s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-bx586   2/2     Running           <span style=color:#ae81ff>0</span>          30s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl port-forward -n demo-linkerd pods/gateway-c549bf99c-q2dpd 8080:8080
</span></span><span style=display:flex><span>Forwarding from 127.0.0.1:8080 -&gt; <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>Forwarding from <span style=color:#f92672>[</span>::1<span style=color:#f92672>]</span>:8080 -&gt; <span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><hr><h4 id=start-sending-requests-to-the-flow>Start sending requests to the Flow</h4><p>Now that the Flow is ready to serve traffic, let&rsquo;s build a toy DocumentArray of 100_000 Documents & start posting requests using jina.Client.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> jina <span style=color:#f92672>import</span> Document, DocumentArray, Client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_done</span>(r):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>datetime<span style=color:#f92672>.</span>now()<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{</span>r<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>da <span style=color:#f92672>=</span> DocumentArray(Document(text<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;text </span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100_000</span>))
</span></span><span style=display:flex><span>Client(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;grpc://localhost:8080&#39;</span>)<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>    on<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/&#39;</span>,
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>=</span>da,
</span></span><span style=display:flex><span>    on_done<span style=color:#f92672>=</span>on_done,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:14.337450, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772554727376&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:15.340458, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772551648312&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:16.344768, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772554727376&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:17.355545, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772551648312&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:18.357875, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772554727376&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span></code></pre></div><hr><h4 id=exploring-the-linkerd-dashboard>Exploring the Linkerd dashboard</h4><p>We can see the how the deployments are connected.</p><p align=center><img src=/images/jina-linkerd/graph.png alt="Topology graph" width=60%></p><p>Latency & TCP metrics for each deployment are available in the same dashboard. As expected, &ldquo;bulky-executor&rdquo; is emitting responses at a much higher size compared to other Pods.</p><p align=center><img src=/images/jina-linkerd/all-latencies.png alt="All latencies" width=90%>
<img src=/images/jina-linkerd/tcp-metrics.png alt="TCP metrics" width=90%></p><p>You&rsquo;d notice something weird in the Grafana dashboard of <code>slow-executor</code> Pod. If you look at the latency, there&rsquo;s a sudden burst and p50 latency has gone upto 50s.</p><p align=center><img src=/images/jina-linkerd/slow-executor-growing-latency.png alt="slow-executor Latency" width=100%></p><p>Though the responses on the Client side are still at the expected 1sec (the sleep time in slow-executor) interval.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:29.418764, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772551648312&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:30.420725, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772554727376&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:31.430988, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772551648312&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:32.436035, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772554727376&gt;</span>
</span></span></code></pre></div><hr><h4 id=what-does-it-mean-by-having-an-average-latency-of-50secs-then>What does it mean by having an average latency of 50secs then?</h4><p>Let&rsquo;s start another Python terminal & start sending requests via another Client.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> jina <span style=color:#f92672>import</span> Document, DocumentArray, Client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>da <span style=color:#f92672>=</span> DocumentArray(Document(text<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;text </span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>Client(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;grpc://localhost:8080&#39;</span>)<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>    on<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/&#39;</span>,
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>=</span>da,
</span></span><span style=display:flex><span>    on_done<span style=color:#f92672>=</span>print,
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>It doesn&rsquo;t get any responses! Looks like, we are a victim of a DDoS attack ü§Ø</p><hr><h4 id=how-do-we-solve-it>How do we solve it?</h4><p>We have an argument called <code>prefetch</code> for exactly the same purpose. Here&rsquo;s an example which limits to a maximum of 5 requests at a time at the Gateway, hence not overloading the &ldquo;slow-executor`. <a href=https://docs.jina.ai/fundamentals/gateway/#limit-outstanding-requests>Read more about the prefetch arg in Jina docs</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>jtype</span>: <span style=color:#ae81ff>Flow</span>
</span></span><span style=display:flex><span><span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>prefetch</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>executors</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><p>Alright. There&rsquo;s a way to get around it. Let&rsquo;s recreate the K8S yamls, redeploy everything, start posting requests again & check the dashboard.</p><p>p50 latency seems to be stable at 6s now, compared to the 50s before.</p><p align=center><img src=/images/jina-linkerd/constant-latency.png alt="constant latency" width=100%></p><hr><p>Let&rsquo;s start sending requests via another Client again.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> jina <span style=color:#f92672>import</span> Document, DocumentArray, Client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>da <span style=color:#f92672>=</span> DocumentArray(Document(text<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;text </span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>Client(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;grpc://localhost:8080&#39;</span>)<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>    on<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/&#39;</span>,
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>=</span>da,
</span></span><span style=display:flex><span>    on_done<span style=color:#f92672>=</span>print,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:46.524090, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 140093958858176&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:47.527269, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 140093958858512&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:48.530814, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 140093958859744&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:49.536981, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 140093958858512&gt;</span>
</span></span></code></pre></div><p>Awesome! The Flow is no more a victim of one bad Client.</p><hr><h2 id=gotchas>Gotchas?</h2><ul><li>With 0 code changes in our Executors, Linkerd provided us a pretty nice way to trace requests in Jina. With this, we could debug & fix a DDoS attack by a malicious client.</li><li>All communication between Gateway & Executors happen using gRPC. We didn&rsquo;t have to configure anything, Linkerd takes care of proxying HTTP, HTTP/2, gRPC traffic smoothly.</li><li>Linkerd provided latency-aware load balancing, which is a great feature in case we want to use more replicas with any Executor.</li></ul></div></article></main></div><footer><hr><p id=social>Find me around the web:<br><a href=https://github.com/deepankarm>GitHub</a>
|
<a href=https://www.linkedin.com/in/deepankar-mahapatro/>Linkedin</a></p><p class=copyright>Copyright ¬© 2022
<a href=http://deepankarm.github.io/><strong>Deepankar Mahapatro</strong></a>.
This work is licensed under the
<a href=http://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a> license.</p><p class=builtWith>Built with
<a href=http://www.gohugo.io/>Hugo</a>,
using the theme
<a href=https://gitlab.com/ian-s-mcb/smigle-hugo-theme>smigle</a>,
which was influenced by the theme
<a href=https://github.com/sumnerevans/smol>smol</a>.</p></footer></body></html>