<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Jina ü§ù Linkerd | deepankar.log</title><meta name=keywords content="jina,service-mesh,linkerd,kubernetes"><meta name=description content="Service meshing deployments in Jina"><meta name=author content="Deepankar Mahapatro"><link rel=canonical href=https://deepankarm.github.io/posts/jina-linkerd/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://deepankarm.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://deepankarm.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://deepankarm.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://deepankarm.github.io/apple-touch-icon.png><link rel=mask-icon href=https://deepankarm.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://deepankarm.github.io/posts/jina-linkerd/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "09cbd7674917411283ca3c61ea31135d"}'></script><meta property="og:url" content="https://deepankarm.github.io/posts/jina-linkerd/"><meta property="og:site_name" content="deepankar.log"><meta property="og:title" content="Jina ü§ù Linkerd"><meta property="og:description" content="Service meshing deployments in Jina"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-16T12:49:55+05:30"><meta property="article:modified_time" content="2022-06-16T12:49:55+05:30"><meta property="article:tag" content="Jina"><meta property="article:tag" content="Service-Mesh"><meta property="article:tag" content="Linkerd"><meta property="article:tag" content="Kubernetes"><meta name=twitter:card content="summary"><meta name=twitter:title content="Jina ü§ù Linkerd"><meta name=twitter:description content="Service meshing deployments in Jina"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://deepankarm.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Jina ü§ù Linkerd","item":"https://deepankarm.github.io/posts/jina-linkerd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Jina ü§ù Linkerd","name":"Jina ü§ù Linkerd","description":"Service meshing deployments in Jina","keywords":["jina","service-mesh","linkerd","kubernetes"],"articleBody":"Let‚Äôs discuss today about a way to debug your Executors \u0026 Flows using Linkerd service mesh.\nWhat is a Service Mesh? From Linkerd docs\nA service mesh is a tool for adding observability, security, and reliability features to ‚Äúcloud native‚Äù applications by transparently inserting this functionality at the platform layer rather than the application layer.\nFew of the commonly used service meshes are Linkerd, Istio, Consul etc.\nWhy Linkerd? Significantly lighter than competitors. Basic request tracing with no additional config. Telemetry \u0026 monitoring exposing Golden metrics. The simplicity of its usage is mind-blowing. Just annotate the K8S Deployment, and you‚Äôre done. How does Linkerd work? While this majorly underestimates the magic Linkerd brings, here are the major components. Feel free to go through the architecture in official docs.\nData Plane This sits next to your application (K8S Pod), hence called the data plane.\nlinkerd-proxy: A sidecar container next to your Pod via which all traffic goes in \u0026 out. linkerd-init: An init container in the Pod to configure the iptables so traffic flows through the proxy. Control Plane This sits in a different namespace (linkerd by default).\ndestination: Informs the linkerd-proxy about routing \u0026 TLS at destination. identity: Manages TLS certificates for proxy-to-proxy mutual TLS. proxy-injector: Adds the data-plane Pods to your Deployment. Jina \u0026 Linkerd Installation Follow the official docs to install Linkerd CLI, Control plane \u0026 the dashboard on your cluster.\nüëâ Linkerd Getting started\nAnnotations in Flow related K8S yamls By default, when we export K8S yamls from a Flow, jina adds all linkerd annotations.\nApplying the K8S yamls adds the linkerd-proxy container to your Pod (Note 2 containers per Pod)\n$ kubectl apply -R -f flowdir/ $ kubectl get pods -n NAME READY STATUS RESTARTS AGE embeddingsfilter-8598855df4-bp54j 2/2 Running 0 100m gateway-8b45c579c-c9bcb 2/2 Running 0 100m pqliteindexer-58c7dc7986-jlnnz 2/2 Running 0 100m transformertorchencoder-6d9875f575-jrx45 2/2 Running 0 100m To tail the logs of the executor, you must pass the container name (executor).\n$ kubectl logs gateway-8b45c579c-c9bcb -n -f error: a container name must be specified for pod gateway-8b45c579c-c9bcb, choose one of: [linkerd-proxy executor] or one of the init containers: [linkerd-init] $ kubectl logs gateway-8b45c579c-c9bcb executor -n -f INFO: 127.0.0.1:35370 - \"POST /post HTTP/1.1\" 200 OK INFO: 127.0.0.1:35372 - \"POST /post HTTP/1.1\" 200 OK Explore the dashboard linkerd viz dashboard \u0026 Note the ‚ÄúMeshed‚Äù section for our namespace. All 4 Pods are meshed (include the ‚Äúlinkerd-proxy‚Äù container).\nThat‚Äôs it. It is that simple to integrate a service mesh \u0026 get the benefits such as mTLS, latency aware load-balancing, basic request tracing, easier retries \u0026 timeouts etc.\nLet‚Äôs build \u0026 debug an application Define \u0026 publish an Executor For demo purpose, I created a ‚Äúdummy‚Äù heavy Executor. Depending on the arguments passed, it‚Äôd sleep for some time or, add embeddings to the DocumentArray. This can be any of the heavy Executors in Hub.\nimport time import numpy as np from jina import DocumentArray, Executor, requests class HeavyExecutorLinkerdDemo(Executor): def __init__(self, n_dim: int = 256, sleep: int = 3, *args, **kwargs): super().__init__(*args, **kwargs) self.n_dim = n_dim self.sleep = sleep @requests def foo(self, docs: DocumentArray, **kwargs): time.sleep(self.sleep) if self.n_dim != -1: docs.embeddings = np.random.random([len(docs), self.n_dim]) It is already pushed to Hub and can be used with jinahub://HeavyExecutorLinkerdDemo syntax.\nDefine \u0026 deploy the Flow Now, let‚Äôs define a Flow with 2 Executors\n‚Äúslow_executor‚Äù: Sleeps for 1 sec per request ‚Äúbulky_executor‚Äù: Adds a random embedding to each Document in the DA jtype: Flow executors: # A slow Executor # sleeps 1 secs per request - name: slow_executor uses: jinahub+docker://HeavyExecutorLinkerdDemo uses_with: n_dim: -1 sleep: 1 # A bulky Executor # Adds a 512 dim embedding to each Document in the DA - name: bulky_executor uses: jinahub+docker://HeavyExecutorLinkerdDemo uses_with: n_dim: 512 sleep: 0 We can export K8S yamls from this Flow, apply them, wait for the Pods to start \u0026 expose the Gateway using ‚Äúport-forward‚Äù.\n$ jina export kubernetes flow.yml demo-linkerd --k8s-namespace demo-linkerd $ kubectl create namespace demo-linkerd $ kubectl apply -R -f demo-linkerd/ $ kubectl get pods -n demo-linkerd -w NAME READY STATUS RESTARTS AGE fast-executor-5b5b68d449-l6nwf 0/2 PodInitializing 0 18s gateway-c549bf99c-q2dpd 2/2 Running 0 18s slow-executor-7c7bb75cfd-bx586 0/2 PodInitializing 0 18s slow-executor-7c7bb75cfd-sc7h6 0/2 PodInitializing 0 18s slow-executor-7c7bb75cfd-bx586 0/2 Running 0 20s slow-executor-7c7bb75cfd-bx586 1/2 Running 0 20s fast-executor-5b5b68d449-l6nwf 0/2 Running 0 22s fast-executor-5b5b68d449-l6nwf 1/2 Running 0 22s slow-executor-7c7bb75cfd-sc7h6 0/2 Running 0 25s slow-executor-7c7bb75cfd-sc7h6 1/2 Running 0 25s fast-executor-5b5b68d449-l6nwf 2/2 Running 0 30s slow-executor-7c7bb75cfd-sc7h6 2/2 Running 0 30s slow-executor-7c7bb75cfd-bx586 2/2 Running 0 30s $ kubectl port-forward -n demo-linkerd pods/gateway-c549bf99c-q2dpd 8080:8080 Forwarding from 127.0.0.1:8080 -\u003e 8080 Forwarding from [::1]:8080 -\u003e 8080 Start sending requests to the Flow Now that the Flow is ready to serve traffic, let‚Äôs build a toy DocumentArray of 100_000 Documents \u0026 start posting requests using jina.Client.\nfrom datetime import datetime from jina import Document, DocumentArray, Client def on_done(r): print(f'{datetime.now()}, {r}') da = DocumentArray(Document(text=f'text {i}') for i in range(100_000)) Client(host='grpc://localhost:8080').post( on='/', inputs=da, on_done=on_done, ) # 2022-06-16 22:50:14.337450, ","wordCount":"1307","inLanguage":"en","datePublished":"2022-06-16T12:49:55+05:30","dateModified":"2022-06-16T12:49:55+05:30","author":{"@type":"Person","name":"Deepankar Mahapatro"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://deepankarm.github.io/posts/jina-linkerd/"},"publisher":{"@type":"Organization","name":"deepankar.log","logo":{"@type":"ImageObject","url":"https://deepankarm.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://deepankarm.github.io/ accesskey=h title="deepankar.log (Alt + H)">deepankar.log</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://deepankarm.github.io/ title=Home><span>Home</span></a></li><li><a href=https://deepankarm.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://deepankarm.github.io/about/ title=About><span>About</span></a></li><li><a href=https://github.com/deepankarm title=GitHub><span>GitHub</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.linkedin.com/in/deepankar-mahapatro/ title=LinkedIn><span>LinkedIn</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Jina ü§ù Linkerd</h1><div class=post-description>Service meshing deployments in Jina</div><div class=post-meta><span title='2022-06-16 12:49:55 +0530 +0530'>June 16, 2022</span>&nbsp;¬∑&nbsp;<span>7 min</span>&nbsp;¬∑&nbsp;<span>Deepankar Mahapatro</span></div></header><div class=post-content><p>Let&rsquo;s discuss today about a way to debug your Executors & Flows using Linkerd service mesh.</p><hr><h2 id=what-is-a-service-mesh>What is a Service Mesh?<a hidden class=anchor aria-hidden=true href=#what-is-a-service-mesh>#</a></h2><p>From Linkerd <a href=https://buoyant.io/service-mesh-manifesto/>docs</a></p><blockquote><p>A service mesh is a tool for adding observability, security, and reliability features to ‚Äúcloud native‚Äù applications by transparently inserting this functionality at the platform layer rather than the application layer.</p></blockquote><p>Few of the commonly used service meshes are Linkerd, Istio, Consul etc.</p><hr><h2 id=why-linkerd>Why Linkerd?<a hidden class=anchor aria-hidden=true href=#why-linkerd>#</a></h2><ul><li>Significantly lighter than competitors.</li><li>Basic request tracing with no additional config.</li><li>Telemetry & monitoring exposing <a href=https://linkerd.io/2.11/features/telemetry/#golden-metrics>Golden metrics</a>.</li><li>The simplicity of its usage is mind-blowing. Just annotate the K8S Deployment, and you&rsquo;re done.</li></ul><hr><h2 id=how-does-linkerd-work>How does Linkerd work?<a hidden class=anchor aria-hidden=true href=#how-does-linkerd-work>#</a></h2><p>While this majorly underestimates the magic Linkerd brings, here are the major components. Feel free to go through the architecture in <a href=https://linkerd.io/2.11/reference/architecture/>official docs</a>.</p><p align=center><a href=https://linkerd.io/2.11/reference/architecture/><img src=/images/jina-linkerd/linkerd-control-plane.png alt="Linkerd architecture" width=80%></a></p><h4 id=data-plane>Data Plane<a hidden class=anchor aria-hidden=true href=#data-plane>#</a></h4><p>This sits next to your application (K8S Pod), hence called the data plane.</p><ol><li><a href=https://linkerd.io/2.11/reference/architecture/#proxy>linkerd-proxy</a>: A sidecar container next to your Pod via which all traffic goes in & out.</li><li><a href=https://linkerd.io/2.11/reference/architecture/#linkerd-init-container>linkerd-init</a>: An init container in the Pod to configure the iptables so traffic flows through the proxy.</li></ol><h4 id=control-plane>Control Plane<a hidden class=anchor aria-hidden=true href=#control-plane>#</a></h4><p>This sits in a different namespace (<code>linkerd</code> by default).</p><ol><li><a href=https://linkerd.io/2.11/reference/architecture/#the-destination-service>destination</a>: Informs the linkerd-proxy about routing & TLS at destination.</li><li><a href=https://linkerd.io/2.11/reference/architecture/#the-identity-service>identity</a>: Manages TLS certificates for proxy-to-proxy mutual TLS.</li><li><a href=https://linkerd.io/2.11/reference/architecture/#the-proxy-injector>proxy-injector</a>: Adds the data-plane Pods to your Deployment.</li></ol><hr><h2 id=jina--linkerd>Jina & Linkerd<a hidden class=anchor aria-hidden=true href=#jina--linkerd>#</a></h2><h4 id=installation>Installation<a hidden class=anchor aria-hidden=true href=#installation>#</a></h4><p>Follow the official docs to install Linkerd CLI, Control plane & the dashboard on your cluster.</p><p>üëâ <a href=https://linkerd.io/2.11/getting-started/>Linkerd Getting started</a></p><h4 id=annotations-in-flow-related-k8s-yamls>Annotations in Flow related K8S yamls<a hidden class=anchor aria-hidden=true href=#annotations-in-flow-related-k8s-yamls>#</a></h4><p>By default, when we <a href=https://docs.jina.ai/fundamentals/flow/create-flow/#kubernetes>export K8S yamls from a Flow</a>, jina adds all linkerd annotations.</p><p align=center><a href=#><img src=/images/jina-linkerd/annotation.png alt="Linkerd annotation" width=50%></a></p><p>Applying the K8S yamls adds the linkerd-proxy container to your Pod (Note 2 containers per Pod)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -R -f flowdir/
</span></span><span style=display:flex><span>$ kubectl get pods -n &lt;namespace&gt;
</span></span><span style=display:flex><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>embeddingsfilter-8598855df4-bp54j          2/2     Running   <span style=color:#ae81ff>0</span>          100m
</span></span><span style=display:flex><span>gateway-8b45c579c-c9bcb                    2/2     Running   <span style=color:#ae81ff>0</span>          100m
</span></span><span style=display:flex><span>pqliteindexer-58c7dc7986-jlnnz             2/2     Running   <span style=color:#ae81ff>0</span>          100m
</span></span><span style=display:flex><span>transformertorchencoder-6d9875f575-jrx45   2/2     Running   <span style=color:#ae81ff>0</span>          100m
</span></span></code></pre></div><p>To tail the logs of the executor, you must pass the container name (<code>executor</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl logs gateway-8b45c579c-c9bcb -n &lt;namespace&gt; -f
</span></span><span style=display:flex><span>error: a container name must be specified <span style=color:#66d9ef>for</span> pod gateway-8b45c579c-c9bcb, choose one of: <span style=color:#f92672>[</span>linkerd-proxy executor<span style=color:#f92672>]</span> or one of the init containers: <span style=color:#f92672>[</span>linkerd-init<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl logs gateway-8b45c579c-c9bcb executor -n &lt;namespace&gt; -f
</span></span><span style=display:flex><span>INFO:     127.0.0.1:35370 - <span style=color:#e6db74>&#34;POST /post HTTP/1.1&#34;</span> <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>INFO:     127.0.0.1:35372 - <span style=color:#e6db74>&#34;POST /post HTTP/1.1&#34;</span> <span style=color:#ae81ff>200</span> OK
</span></span></code></pre></div><h4 id=explore-the-dashboard>Explore the dashboard<a hidden class=anchor aria-hidden=true href=#explore-the-dashboard>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>linkerd viz dashboard &amp;
</span></span></code></pre></div><p>Note the &ldquo;Meshed&rdquo; section for our namespace. All 4 Pods are meshed (include the &ldquo;linkerd-proxy&rdquo; container).</p><p align=center><img src=/images/jina-linkerd/dashboard.png alt="Linkerd dashboard" width=80%></p><p>That&rsquo;s it. It is that simple to integrate a service mesh & get the benefits such as mTLS, latency aware load-balancing, basic request tracing, easier retries & timeouts etc.</p><hr><h2 id=lets-build--debug-an-application>Let&rsquo;s build & debug an application<a hidden class=anchor aria-hidden=true href=#lets-build--debug-an-application>#</a></h2><h4 id=define--publish-an-executor>Define & publish an Executor<a hidden class=anchor aria-hidden=true href=#define--publish-an-executor>#</a></h4><p>For demo purpose, I created a &ldquo;dummy&rdquo; heavy Executor. Depending on the arguments passed, it&rsquo;d sleep for some time or, add embeddings to the DocumentArray. This can be any of the heavy Executors in <a href=hub.jina.ai>Hub</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> jina <span style=color:#f92672>import</span> DocumentArray, Executor, requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HeavyExecutorLinkerdDemo</span>(Executor):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, n_dim: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>256</span>, sleep: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span><span style=color:#a6e22e>__init__</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>n_dim <span style=color:#f92672>=</span> n_dim
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>sleep <span style=color:#f92672>=</span> sleep
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@requests</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>(self, docs: DocumentArray, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(self<span style=color:#f92672>.</span>sleep)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>n_dim <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>            docs<span style=color:#f92672>.</span>embeddings <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>random<span style=color:#f92672>.</span>random([len(docs), self<span style=color:#f92672>.</span>n_dim])
</span></span></code></pre></div><p>It is already pushed to <a href=https://hub.jina.ai/executor/qgy74myk>Hub</a> and can be used with <code>jinahub://HeavyExecutorLinkerdDemo</code> syntax.</p><hr><h4 id=define--deploy-the-flow>Define & deploy the Flow<a hidden class=anchor aria-hidden=true href=#define--deploy-the-flow>#</a></h4><p>Now, let&rsquo;s define a Flow with 2 Executors</p><ul><li>&ldquo;slow_executor&rdquo;: Sleeps for 1 sec per request</li><li>&ldquo;bulky_executor&rdquo;: Adds a random embedding to each Document in the DA</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>jtype</span>: <span style=color:#ae81ff>Flow</span>
</span></span><span style=display:flex><span><span style=color:#f92672>executors</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># A slow Executor</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># sleeps 1 secs per request</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>slow_executor</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>jinahub+docker://HeavyExecutorLinkerdDemo</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses_with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>n_dim</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sleep</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># A bulky Executor</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Adds a 512 dim embedding to each Document in the DA</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bulky_executor</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>jinahub+docker://HeavyExecutorLinkerdDemo</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses_with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>n_dim</span>: <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sleep</span>: <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>We can export K8S yamls from this Flow, apply them, wait for the Pods to start & expose the Gateway using &ldquo;port-forward&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ jina export kubernetes flow.yml demo-linkerd --k8s-namespace demo-linkerd
</span></span><span style=display:flex><span>$ kubectl create namespace demo-linkerd
</span></span><span style=display:flex><span>$ kubectl apply -R -f demo-linkerd/
</span></span><span style=display:flex><span>$ kubectl get pods -n demo-linkerd -w
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                             READY   STATUS            RESTARTS   AGE
</span></span><span style=display:flex><span>fast-executor-5b5b68d449-l6nwf   0/2     PodInitializing   <span style=color:#ae81ff>0</span>          18s
</span></span><span style=display:flex><span>gateway-c549bf99c-q2dpd          2/2     Running           <span style=color:#ae81ff>0</span>          18s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-bx586   0/2     PodInitializing   <span style=color:#ae81ff>0</span>          18s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-sc7h6   0/2     PodInitializing   <span style=color:#ae81ff>0</span>          18s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-bx586   0/2     Running           <span style=color:#ae81ff>0</span>          20s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-bx586   1/2     Running           <span style=color:#ae81ff>0</span>          20s
</span></span><span style=display:flex><span>fast-executor-5b5b68d449-l6nwf   0/2     Running           <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>fast-executor-5b5b68d449-l6nwf   1/2     Running           <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-sc7h6   0/2     Running           <span style=color:#ae81ff>0</span>          25s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-sc7h6   1/2     Running           <span style=color:#ae81ff>0</span>          25s
</span></span><span style=display:flex><span>fast-executor-5b5b68d449-l6nwf   2/2     Running           <span style=color:#ae81ff>0</span>          30s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-sc7h6   2/2     Running           <span style=color:#ae81ff>0</span>          30s
</span></span><span style=display:flex><span>slow-executor-7c7bb75cfd-bx586   2/2     Running           <span style=color:#ae81ff>0</span>          30s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl port-forward -n demo-linkerd pods/gateway-c549bf99c-q2dpd 8080:8080
</span></span><span style=display:flex><span>Forwarding from 127.0.0.1:8080 -&gt; <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>Forwarding from <span style=color:#f92672>[</span>::1<span style=color:#f92672>]</span>:8080 -&gt; <span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><hr><h4 id=start-sending-requests-to-the-flow>Start sending requests to the Flow<a hidden class=anchor aria-hidden=true href=#start-sending-requests-to-the-flow>#</a></h4><p>Now that the Flow is ready to serve traffic, let&rsquo;s build a toy DocumentArray of 100_000 Documents & start posting requests using jina.Client.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> jina <span style=color:#f92672>import</span> Document, DocumentArray, Client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_done</span>(r):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>datetime<span style=color:#f92672>.</span>now()<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>{</span>r<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>da <span style=color:#f92672>=</span> DocumentArray(Document(text<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;text </span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100_000</span>))
</span></span><span style=display:flex><span>Client(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;grpc://localhost:8080&#39;</span>)<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>    on<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/&#39;</span>,
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>=</span>da,
</span></span><span style=display:flex><span>    on_done<span style=color:#f92672>=</span>on_done,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:14.337450, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772554727376&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:15.340458, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772551648312&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:16.344768, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772554727376&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:17.355545, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772551648312&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:18.357875, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772554727376&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span></code></pre></div><hr><h4 id=exploring-the-linkerd-dashboard>Exploring the Linkerd dashboard<a hidden class=anchor aria-hidden=true href=#exploring-the-linkerd-dashboard>#</a></h4><p>We can see the how the deployments are connected.</p><p align=center><img src=/images/jina-linkerd/graph.png alt="Topology graph" width=60%></p><p>Latency & TCP metrics for each deployment are available in the same dashboard. As expected, &ldquo;bulky-executor&rdquo; is emitting responses at a much higher size compared to other Pods.</p><p align=center><img src=/images/jina-linkerd/all-latencies.png alt="All latencies" width=90%>
<img src=/images/jina-linkerd/tcp-metrics.png alt="TCP metrics" width=90%></p><p>You&rsquo;d notice something weird in the Grafana dashboard of <code>slow-executor</code> Pod. If you look at the latency, there&rsquo;s a sudden burst and p50 latency has gone upto 50s.</p><p align=center><img src=/images/jina-linkerd/slow-executor-growing-latency.png alt="slow-executor Latency" width=100%></p><p>Though the responses on the Client side are still at the expected 1sec (the sleep time in slow-executor) interval.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:29.418764, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772551648312&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:30.420725, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772554727376&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:31.430988, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772551648312&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:32.436035, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 139772554727376&gt;</span>
</span></span></code></pre></div><hr><h4 id=what-does-it-mean-by-having-an-average-latency-of-50secs-then>What does it mean by having an average latency of 50secs then?<a hidden class=anchor aria-hidden=true href=#what-does-it-mean-by-having-an-average-latency-of-50secs-then>#</a></h4><p>Let&rsquo;s start another Python terminal & start sending requests via another Client.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> jina <span style=color:#f92672>import</span> Document, DocumentArray, Client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>da <span style=color:#f92672>=</span> DocumentArray(Document(text<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;text </span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>Client(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;grpc://localhost:8080&#39;</span>)<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>    on<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/&#39;</span>,
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>=</span>da,
</span></span><span style=display:flex><span>    on_done<span style=color:#f92672>=</span>print,
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>It doesn&rsquo;t get any responses! Looks like, we are a victim of a DDoS attack ü§Ø</p><hr><h4 id=how-do-we-solve-it>How do we solve it?<a hidden class=anchor aria-hidden=true href=#how-do-we-solve-it>#</a></h4><p>We have an argument called <code>prefetch</code> for exactly the same purpose. Here&rsquo;s an example which limits to a maximum of 5 requests at a time at the Gateway, hence not overloading the &ldquo;slow-executor`. <a href=https://docs.jina.ai/fundamentals/gateway/#limit-outstanding-requests>Read more about the prefetch arg in Jina docs</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>jtype</span>: <span style=color:#ae81ff>Flow</span>
</span></span><span style=display:flex><span><span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>prefetch</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>executors</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><p>Alright. There&rsquo;s a way to get around it. Let&rsquo;s recreate the K8S yamls, redeploy everything, start posting requests again & check the dashboard.</p><p>p50 latency seems to be stable at 6s now, compared to the 50s before.</p><p align=center><img src=/images/jina-linkerd/constant-latency.png alt="constant latency" width=100%></p><hr><p>Let&rsquo;s start sending requests via another Client again.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> jina <span style=color:#f92672>import</span> Document, DocumentArray, Client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>da <span style=color:#f92672>=</span> DocumentArray(Document(text<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;text </span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100</span>))
</span></span><span style=display:flex><span>Client(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;grpc://localhost:8080&#39;</span>)<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>    on<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/&#39;</span>,
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>=</span>da,
</span></span><span style=display:flex><span>    on_done<span style=color:#f92672>=</span>print,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:46.524090, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 140093958858176&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:47.527269, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 140093958858512&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:48.530814, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 140093958859744&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2022-06-16 22:50:49.536981, &lt;jina.types.request.data.DataRequest (&#39;header&#39;, &#39;parameters&#39;, &#39;routes&#39;, &#39;data&#39;) at 140093958858512&gt;</span>
</span></span></code></pre></div><p>Awesome! The Flow is no more a victim of one bad Client.</p><hr><h2 id=gotchas>Gotchas?<a hidden class=anchor aria-hidden=true href=#gotchas>#</a></h2><ul><li>With 0 code changes in our Executors, Linkerd provided us a pretty nice way to trace requests in Jina. With this, we could debug & fix a DDoS attack by a malicious client.</li><li>All communication between Gateway & Executors happen using gRPC. We didn&rsquo;t have to configure anything, Linkerd takes care of proxying HTTP, HTTP/2, gRPC traffic smoothly.</li><li>Linkerd provided latency-aware load balancing, which is a great feature in case we want to use more replicas with any Executor.</li><li>Always use the right <code>prefetch</code> with your Flow!</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://deepankarm.github.io/tags/jina/>Jina</a></li><li><a href=https://deepankarm.github.io/tags/service-mesh/>Service-Mesh</a></li><li><a href=https://deepankarm.github.io/tags/linkerd/>Linkerd</a></li><li><a href=https://deepankarm.github.io/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://deepankarm.github.io/posts/streaming-partial-json-llm/><span class=title>¬´ Prev</span><br><span>Streaming Partial JSON from LLMs in Go</span>
</a><a class=next href=https://deepankarm.github.io/posts/jina-serverless/><span class=title>Next ¬ª</span><br><span>Jina ‚ù§Ô∏è Serverless</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://deepankarm.github.io/>deepankar.log</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>