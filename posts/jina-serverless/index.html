<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><title>Jina ❤️ Serverless | Deepankar's Tech Blogs</title><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/font.css><link rel=stylesheet href=/css/smigle.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><header><div id=brand><a class=icon-link href=http://deepankarm.github.io/><img class=icon src=/images/brandIcon.svg></a><div class=text><a href=http://deepankarm.github.io/><h1>Deepankar's Tech Blogs</h1></a><h3>Engineering Manager - Jina AI</h3></div></div><nav><a href=/><b>Home</b></a>
|
<a href=/about/><b>About</b></a>
|
<a href=/posts/><b>Posts</b></a></nav><hr></header><div id=content><main><article><h1>Jina ❤️ Serverless</h1><div class=post-meta><strong><span>Posted on</span>
<time>2022-06-15 17:49:55</time></strong>
<span>• 739 words</span>
<span>• 4 minute read</span><div><span>Tags:</span>
<a href=/tags/jina>jina</a>,
<a href=/tags/serverless>serverless</a>,
<a href=/tags/kubernetes>kubernetes</a></div></div><div><hr><h2 id=what-is-jina>What is Jina?</h2><p>From the <a href=https://docs.jina.ai/>Docs</a></p><blockquote><p>Jina is a framework that empowers anyone to build cross-modal and multi-modal applications on the cloud.</p></blockquote><hr><h2 id=what-is-serverless>What is serverless?</h2><p>From <a href=https://en.wikipedia.org/wiki/Serverless_computing>Wikipedia</a></p><blockquote><p>Serverless computing is a cloud computing execution model in which the cloud provider allocates machine resources on demand, taking care of the servers on behalf of their customers.</p></blockquote><p>Also,</p><blockquote><p>&ldquo;Serverless&rdquo; is a misnomer in the sense that servers are still used by cloud service providers to execute code for developers. However, developers of serverless applications are not concerned with capacity planning, configuration, management, maintenance, fault tolerance, or scaling of containers, VMs, or physical servers.</p></blockquote><hr><h2 id=why-do-the-jina-users-care>Why do the Jina users care?</h2><ul><li>No headache of setting the <a href=https://docs.jina.ai/how-to/scale-out/#scale-out-your-executor>right number of replicas</a>.</li><li>Scale-to-0 saves a lot of cost, especially when you&rsquo;re starting to host your app.</li><li>Many use cases in Jina doesn&rsquo;t need <a href=https://docs.jina.ai/fundamentals/executor/>Executors</a> or <a href=https://docs.jina.ai/fundamentals/gateway/>Gateway</a> to be always alive.</li><li>Serverless allows invocations to be &ldquo;event-driven&rdquo;.</li></ul><hr><h2 id=what-is-this-demo-about>What is this demo about?</h2><p>We&rsquo;ll use <a href=https://knative.dev/docs/>Knative serving</a> along with <a href=https://linkerd.io/2.11/overview/>Linkerd service mesh</a> & show</p><ul><li>How does serverless work in a K8S world?</li><li>How simple it is to enable autoscaling (from 0 to N) in jina?</li></ul><hr><h2 id=why-knative>Why Knative?</h2><p>Knative allows us to scale from 0 to N, based on</p><ul><li><a href=https://knative.dev/docs/serving/autoscaling/concurrency/>concurrency</a> or <a href=https://knative.dev/docs/serving/autoscaling/rps-target/>rps</a>.</li><li>Set min / max number of replicas per deployment.</li><li>Supports <a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/>HPA</a> (Resource metric based 1-to-N scaling provided by K8S) as well.</li><li>Easily integrate with many Ingress controllers.</li></ul><hr><h2 id=demo>Demo</h2><p>As a first step, please clone <a href=https://github.com/deepankarm/jina-serverless-demo.git>jina-serverless-demo</a>, which has the necessary scripts for the demo.</p><h3 id=set-up>Set-up</h3><blockquote><p>You can skip this step if you already have a k8s cluster & setup knative / linkerd components.</p></blockquote><p>Let&rsquo;s start by setting up a local environment where serverless machinery can be demonstrated. Following script installs</p><ul><li><code>kubectl</code>, <code>kind</code> & <code>linkerd</code> CLI, if not already installed.</li><li>A local <code>kind</code> cluster named <code>jina-serverless</code>.</li><li><code>Knative</code> components</li><li><code>Kourier</code> Ingress for Knative</li><li><code>Linkerd</code> components</li><li>Patch <code>Knative</code> & <code>Kourier</code> deployments with <code>Linkerd</code> service-mesh. <a href=https://linkerd.io/2020/03/23/serverless-service-mesh-with-knative-and-linkerd/>Read this awesome doc!</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bash setup.sh
</span></span></code></pre></div><hr><h3 id=define-an-executor--a-flow>Define an Executor & a Flow</h3><p>Let&rsquo;s write a dummy <code>HeavyExecutor</code> which sleeps for 3 seconds every time it receives a new request. This can be replaced with any Executor from <a href=https://hub.jina.ai/>Jina Hub</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># HeavyExecutor/executor.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> jina <span style=color:#f92672>import</span> DocumentArray, Executor, requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HeavyExecutor</span>(Executor):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@requests</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>(self, docs: DocumentArray, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>3</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># flow.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>jtype</span>: <span style=color:#ae81ff>Flow</span>
</span></span><span style=display:flex><span><span style=color:#f92672>executors</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>heavy_executor</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>jinahub+docker://HeavyExecutor</span>
</span></span></code></pre></div><hr><h3 id=convert-flow-to-k8s-yaml>Convert Flow to K8S yaml</h3><p>Now that we have the setup done, let&rsquo;s use the jina CLI to export a dummy Flow yaml into K8S specific yamls.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ jina export kubernetes flow.yml jina-sls --k8s-namespace jina-sls
</span></span><span style=display:flex><span><span style=color:#75715e># K8s yaml files have been created under jina-sls. You can use it by running kubectl apply -R -f jina-sls</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ tree jina-sls
</span></span><span style=display:flex><span>jina-sls
</span></span><span style=display:flex><span>├── gateway
</span></span><span style=display:flex><span>│   └── gateway.yml
</span></span><span style=display:flex><span>└── heavy_executor
</span></span><span style=display:flex><span>    └── heavy-executor.yml
</span></span></code></pre></div><hr><h3 id=convert-to-knative-yaml>Convert to Knative yaml</h3><blockquote><p>This step is temporary and will be implemented as a <a href=https://github.com/jina-ai/jina/issues/4924>feature</a> in Jina.</p></blockquote><p>Knative doesn&rsquo;t understand K8S <code>Deployment</code> & <code>Service</code> resources and implements a <code>Service</code> resource under <code>serving.knative.dev/v1</code> CRD. Let&rsquo;s convert the K8S yamls to Knative yamls using a helper script.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace jina-sls
</span></span><span style=display:flex><span>kubectl apply -R -f <span style=color:#66d9ef>$(</span>python kn/change_to_kn.py jina-sls<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>We might need to wait a bit until all knative objects are setup in addition to the deployments in <code>jina-sls</code> namespace. Before any Client sends requests to the Gateway, let&rsquo;s check & wait until each deployment has 0 replicas.</p><p align=center><a href=#><img src=/images/wait-until-0.png alt="0 replicas" width=60%></a></p><hr><h3 id=gateway-url>Gateway URL</h3><p>To check the URL of the Gateway, you can use the following command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get ksvc -n jina-sls gateway --no-headers -o custom-columns<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;URL:.status.url&#34;</span>
</span></span><span style=display:flex><span>http://gateway.jina-sls.127.0.0.1.sslip.io
</span></span></code></pre></div><p>Note that, the URL here is provided by Knative & hence starts with <code>http</code>. But it is a polyglot Gateway & accepts all 3 protocols of requests supported by jina (gRPC, WebSockets & HTTP), just by passing the right <a href="https://docs.jina.ai/fundamentals/flow/client/#connect:~:text=You%20can%20define%20these%20parameters%20by%20passing%20a%20valid%20URI%20scheme%20as%20part%20of%20the%20host%20argument%3A">URL scheme</a>.</p><hr><h3 id=lets-send-requests-to-the-flow-that-doesnt-exist>Let&rsquo;s send requests to the Flow that doesn&rsquo;t exist!</h3><p>Alright. It took a lot of setup, but now we are ready to see what the fuss is about serverless.</p><p>Let&rsquo;s send just 1 request using <code>jina.Client</code> & keep an eye on the number of replicas per deployment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> jina <span style=color:#f92672>import</span> Client, DocumentArray
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Client(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;grpc://gateway.jina-sls.127.0.0.1.sslip.io&#39;</span>)<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>    on<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/&#39;</span>,
</span></span><span style=display:flex><span>    inputs<span style=color:#f92672>=</span>DocumentArray<span style=color:#f92672>.</span>empty(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>We can observe new replicas popping up for both <code>gateway</code> & <code>heavy-executor</code> after request is sent via the Client.</p><p align=center><a href=#><img src=/images/1-request.gif alt="Scale from 0" width=90%></a></p><p>Now, let&rsquo;s start 10 concurrent Clients that will send requests to the Gateway.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python load.py <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><p>Note the following.</p><ul><li>As soon as we run the <code>load.py</code> script with 10 concurrent clients, new replicas of the <code>gateway</code> & <code>heavy-executor</code> start spawning.</li><li>After a cool down period, all deployments reach the original state of 0 replicas each.</li></ul><p align=center><a href=#><img src=/images/scale-to-10.gif alt="Scale to 10" width=90%></a></p></div></article></main></div><footer><hr><p id=social>Find me around the web:<br><a href=https://github.com/deepankarm>GitHub</a>
|
<a href=https://www.linkedin.com/in/deepankar-mahapatro/>Linkedin</a></p><p class=copyright>Copyright © 2022
<a href=http://deepankarm.github.io/><strong>Deepankar Mahapatro</strong></a>.
This work is licensed under the
<a href=http://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a> license.</p><p class=builtWith>Built with
<a href=http://www.gohugo.io/>Hugo</a>,
using the theme
<a href=https://gitlab.com/ian-s-mcb/smigle-hugo-theme>smigle</a>,
which was influenced by the theme
<a href=https://github.com/sumnerevans/smol>smol</a>.</p></footer></body></html>