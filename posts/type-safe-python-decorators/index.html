<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Type-Safe Python Decorators | deepankar.log</title><meta name=keywords content="python,type hints,decorators,ParamSpec,mypy,pyright"><meta name=description content="A practical guide to getting decorator type hints right with ParamSpec, Concatenate, and generics"><meta name=author content="Deepankar Mahapatro"><link rel=canonical href=https://deepankarm.github.io/posts/type-safe-python-decorators/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://deepankarm.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://deepankarm.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://deepankarm.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://deepankarm.github.io/apple-touch-icon.png><link rel=mask-icon href=https://deepankarm.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://deepankarm.github.io/posts/type-safe-python-decorators/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "09cbd7674917411283ca3c61ea31135d"}'></script><meta property="og:url" content="https://deepankarm.github.io/posts/type-safe-python-decorators/"><meta property="og:site_name" content="deepankar.log"><meta property="og:title" content="Type-Safe Python Decorators"><meta property="og:description" content="A practical guide to getting decorator type hints right with ParamSpec, Concatenate, and generics"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-01T14:00:00+05:30"><meta property="article:modified_time" content="2026-02-01T14:00:00+05:30"><meta property="article:tag" content="python"><meta property="article:tag" content="type hints"><meta property="article:tag" content="decorators"><meta property="article:tag" content="ParamSpec"><meta property="article:tag" content="mypy"><meta property="article:tag" content="pyright"><meta name=twitter:card content="summary"><meta name=twitter:title content="Type-Safe Python Decorators"><meta name=twitter:description content="A practical guide to getting decorator type hints right with ParamSpec, Concatenate, and generics"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"posts","item":"https://deepankarm.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Type-Safe Python Decorators","item":"https://deepankarm.github.io/posts/type-safe-python-decorators/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Type-Safe Python Decorators","name":"Type-Safe Python Decorators","description":"A practical guide to getting decorator type hints right with ParamSpec, Concatenate, and generics","keywords":["python","type hints","decorators","ParamSpec","mypy","pyright"],"articleBody":"Decorators are everywhere in Python. Logging, retries, caching, auth checks - if you’ve built anything non-trivial, you’ve written one. But the moment you try to add type hints, things get weird. Your IDE loses autocomplete. You end up with Callable[..., Any] and pretend the problem doesn’t exist, because Callable can’t express “whatever arguments the wrapped function takes.”\nPEP 612 introduced ParamSpec (Python 3.10+) to solve exactly this. This post walks through using it - from trivial cases to the genuinely painful scenarios I hit while building a multi-LLM agent backend. Read the TL;DR section for a quick summary.\nLevel 1: Simple passthrough decorator The classic timing decorator. It doesn’t change arguments or return types - just wraps the call.\nimport time from functools import wraps from typing import Callable, ParamSpec, TypeVar P = ParamSpec(\"P\") R = TypeVar(\"R\") def timeit(func: Callable[P, R]) -\u003e Callable[P, R]: @wraps(func) def wrapper(*args: P.args, **kwargs: P.kwargs) -\u003e R: start = time.perf_counter() result = func(*args, **kwargs) print(f\"{func.__name__} took {time.perf_counter() - start:.3f}s\") return result return wrapper @timeit def fetch_data(url: str, timeout: int = 30) -\u003e dict[str, str]: ... ParamSpec(\"P\") captures the entire parameter signature. P.args and P.kwargs are special forms that can only appear together in a function signature. The type checker sees fetch_data as (url: str, timeout: int = 30) -\u003e dict[str, str] - signature fully preserved.\nLevel 2: Decorator with arguments @retry(times=3) means retry(times=3) returns the actual decorator. Triple nesting.\nfrom functools import wraps from typing import Callable, ParamSpec, TypeVar P = ParamSpec(\"P\") R = TypeVar(\"R\") def retry(times: int = 3) -\u003e Callable[[Callable[P, R]], Callable[P, R]]: def decorator(func: Callable[P, R]) -\u003e Callable[P, R]: @wraps(func) def wrapper(*args: P.args, **kwargs: P.kwargs) -\u003e R: for attempt in range(times): try: return func(*args, **kwargs) except Exception: if attempt == times - 1: raise raise RuntimeError(\"unreachable\") return wrapper return decorator @retry(times=5) def simple(a: str) -\u003e dict[str, str]: ... @retry(times=5) def complicated(a: int, b: int, c: str = \"default\") -\u003e int: ... The outer function returns Callable[[Callable[P, R]], Callable[P, R]] - a function that takes a callable and returns one with the same signature. Type checkers handle this well.\nLevel 3: Method decorators ParamSpec captures self automatically. The same timeit decorator from Level 1 works on methods without changes.\nimport time from functools import wraps from typing import Callable, ParamSpec, TypeVar P = ParamSpec(\"P\") R = TypeVar(\"R\") def timeit(func: Callable[P, R]) -\u003e Callable[P, R]: @wraps(func) def wrapper(*args: P.args, **kwargs: P.kwargs) -\u003e R: start = time.perf_counter() result = func(*args, **kwargs) print(f\"{func.__name__} took {time.perf_counter() - start:.3f}s\") return result return wrapper class UserService: @timeit def get_user(self, user_id: int) -\u003e dict[str, int]: ... P captures (self: UserService, user_id: int). The type checker is happy, self.get_user(42) has correct autocomplete. No special handling needed.\nBut this breaks when the decorator needs to access self.\nLevel 4: Decorators that access self If the decorator body needs self - for logging via self.logger, checking self.config, etc. - you need Concatenate.\nThe problem: P is atomic. You can’t decompose it to “pull out the first argument.” typing.Concatenate solves this by letting you prepend specific types to a ParamSpec:\nimport logging from functools import wraps from typing import Callable, Concatenate, ParamSpec, TypeVar P = ParamSpec(\"P\") R = TypeVar(\"R\") class Service: logger: logging.Logger SelfT = TypeVar(\"SelfT\", bound=Service) def with_logging( func: Callable[Concatenate[SelfT, P], R], ) -\u003e Callable[Concatenate[SelfT, P], R]: @wraps(func) def wrapper(self: SelfT, *args: P.args, **kwargs: P.kwargs) -\u003e R: self.logger.info(f\"Calling {func.__name__}\") # self is typed as SelfT return func(self, *args, **kwargs) return wrapper class UserService(Service): @with_logging def get_user(self, user_id: int) -\u003e dict[str, int]: ... Mental model for Concatenate:\nOriginal: def get_user(self, user_id: int) -\u003e dict[str, int] ^^^^ ^^^^^^^^^^^^ Concatenate[SelfT, P] matches as: SelfT = UserService (bound to Service) P = (user_id: int) Concatenate prepends SelfT to P, so the full signature is reconstructed as (self: SelfT, *P.args, **P.kwargs). The decorator can use self.logger because SelfT is bound to Service.\nLevel 5: When the base class isn’t enough Here’s where things get interesting. Consider an agent backend where:\nAgent[T] is a generic base class - T is the structured output type Agents gain capabilities through mixins: ObservabilityMixin provides self.record_cost(), MemoryMixin provides self.history Not every agent has every mixin. SummarisationAgent has cost tracking but no memory. ChatAgent has both. Decorators need access to self, but each decorator needs attributes from a different mixin The naive approach - AgentT = TypeVar(\"AgentT\", bound=\"Agent[Any]\") for every decorator - breaks immediately. Agent doesn’t have record_cost(). You could dump every attribute onto the base class, but that defeats the purpose of mixins.\nThe solution: each decorator declares a Protocol for the self it needs, and binds its TypeVar to that Protocol. @track_cost requires HasObservability. @inject_history requires HasMemory. @validate_output only needs the base Agent.\nThe type checker then enforces correctness at the decorator application site. Slapping @inject_history on a SummarisationAgent (which lacks MemoryMixin) is a type error - exactly the bug you want caught at dev time, not when self.history blows up in production.\nfrom abc import ABC, abstractmethod from dataclasses import dataclass from functools import wraps from typing import Any, Callable, Concatenate, Generic, ParamSpec, Protocol, TypeVar # Single set of type variables - shared across all decorators P = ParamSpec(\"P\") R = TypeVar(\"R\") T = TypeVar(\"T\") @dataclass class Summary: condensed: str @dataclass class ChatResponse: reply: str class LLMClient: ... class ObservabilityMixin: def record_cost(self, tokens: int) -\u003e None: ... class MemoryMixin: history: list[dict[str, str]] = [] class HasObservability(Protocol): def record_cost(self, tokens: int) -\u003e None: ... class HasMemory(Protocol): history: list[dict[str, str]] # TypeVars bound to protocols - not to the base class ObservableT = TypeVar(\"ObservableT\", bound=HasObservability) MemoryAwareT = TypeVar(\"MemoryAwareT\", bound=HasMemory) AgentT = TypeVar(\"AgentT\", bound=\"Agent[Any]\") def track_cost( func: Callable[Concatenate[ObservableT, P], R], ) -\u003e Callable[Concatenate[ObservableT, P], R]: \"\"\"Record token usage via self.record_cost. Works on any agent with ObservabilityMixin.\"\"\" @wraps(func) def wrapper(self: ObservableT, *args: P.args, **kwargs: P.kwargs) -\u003e R: result = func(self, *args, **kwargs) self.record_cost(tokens=42) return result return wrapper def inject_history( func: Callable[Concatenate[MemoryAwareT, P], R], ) -\u003e Callable[Concatenate[MemoryAwareT, P], R]: \"\"\"Prepend conversation history. Only works on agents with MemoryMixin.\"\"\" @wraps(func) def wrapper(self: MemoryAwareT, *args: P.args, **kwargs: P.kwargs) -\u003e R: # decorator reads self.history - only available via MemoryMixin _ = self.history return func(self, *args, **kwargs) return wrapper def validate_output( func: Callable[Concatenate[AgentT, P], R], ) -\u003e Callable[Concatenate[AgentT, P], R]: \"\"\"Retry on malformed output. Only needs base Agent attributes.\"\"\" @wraps(func) def wrapper(self: AgentT, *args: P.args, **kwargs: P.kwargs) -\u003e R: result = func(self, *args, **kwargs) for _ in range(self.max_validation_retries - 1): if self.is_valid(result): return result result = func(self, *args, **kwargs) return result return wrapper class Agent(ABC, Generic[T]): llm: LLMClient max_validation_retries: int = 3 def is_valid(self, result: Any) -\u003e bool: ... @abstractmethod def run(self, prompt: str) -\u003e T: ... class SummarisationAgent(ObservabilityMixin, Agent[Summary]): \"\"\"Has cost tracking (ObservabilityMixin), but no memory.\"\"\" @track_cost # ✅ Has ObservabilityMixin → satisfies HasObservability @validate_output def run(self, prompt: str) -\u003e Summary: return Summary(condensed=prompt) class ChatAgent(ObservabilityMixin, MemoryMixin, Agent[ChatResponse]): \"\"\"Has both cost tracking and conversation memory.\"\"\" @track_cost # ✅ Has ObservabilityMixin → satisfies HasObservability @inject_history # ✅ Has MemoryMixin → satisfies HasMemory @validate_output def run(self, prompt: str) -\u003e ChatResponse: return ChatResponse(reply=prompt) class AgentWithoutMemory(Agent[Summary]): \"\"\" ❌ Type error Argument of type \"(self: Self@AgentWithoutMemory, prompt: str) -\u003e Summary\" cannot be assigned to parameter \"func\" of type \"(MemoryAwareT@inject_history, **P@inject_history) -\u003e R@inject_history\" in function \"inject_history\" Type \"(self: Self@AgentWithoutMemory, prompt: str) -\u003e Summary\" is not assignable to type \"(MemoryAwareT@inject_history, **P@inject_history) -\u003e R@inject_history\" Parameter 1: type \"MemoryAwareT@inject_history\" is incompatible with type \"Self@AgentWithoutMemory\" \"HasMemory*\" is not assignable to \"AgentWithoutMemory\"basedpyrightreportArgumentType \"\"\" @inject_history def run(self, prompt: str) -\u003e Summary: return Summary(condensed=prompt) SummarisationAgent uses @track_cost and @validate_output - it has ObservabilityMixin so it satisfies HasObservability, and it extends Agent so it satisfies the base bound. ChatAgent additionally uses @inject_history because it has MemoryMixin. AgentWithoutMemory at the bottom shows what happens when you get it wrong - pyright rejects it because Agent[Summary] alone doesn’t satisfy the HasMemory protocol.\nCommon pitfalls TypeVar shadowing across modules: If decorators in different modules each define their own R = TypeVar(\"R\"), the type checker may fail to unify them when stacked. Define a single set of TypeVars in one module and import everywhere. Stacking order breaks when return types change: If all decorators have identical signatures (Callable[Concatenate[AgentT, P], R] -\u003e Callable[Concatenate[AgentT, P], R]), order doesn’t matter. If one changes the return type (wrapping in Result[R]), the next decorator sees a different R. Debug with reveal_type() - a special form recognized by mypy/pyright that prints the inferred type during checking (not a runtime function). P.kwargs is opaque to the type checker: At runtime, kwargs is a normal mutable dict. But the type checker won’t let you treat P.kwargs as dict[str, Any] - you can’t call kwargs.setdefault() or index into it without a type error. The type system treats ParamSpec kwargs as a sealed contract. Add defaults in the function signature itself, or use cast. @functools.wraps doesn’t affect types: It copies runtime metadata (__name__, __doc__), but the type annotations on your wrapper function are what the type checker sees. Use @wraps for introspection, rely on annotations for correctness. TL;DR Scenario Pattern Simple passthrough Callable[P, R] -\u003e Callable[P, R] Decorator with arguments Outer returns Callable[[Callable[P, R]], Callable[P, R]] - triple nesting Decorator accesses self Concatenate[SelfT, P] with SelfT bound to the base class Decorator accesses mixin state Protocol per decorator, bind SelfT to the protocol instead of the base class Stacking decorators Keep signatures identical across all decorators. Share TypeVars at module level What other decorator typing issues have you run into? I’m curious what I’ve missed.\n","wordCount":"1548","inLanguage":"en","datePublished":"2026-02-01T14:00:00+05:30","dateModified":"2026-02-01T14:00:00+05:30","author":{"@type":"Person","name":"Deepankar Mahapatro"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://deepankarm.github.io/posts/type-safe-python-decorators/"},"publisher":{"@type":"Organization","name":"deepankar.log","logo":{"@type":"ImageObject","url":"https://deepankarm.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://deepankarm.github.io/ accesskey=h title="deepankar.log (Alt + H)">deepankar.log</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://deepankarm.github.io/ title=Home><span>Home</span></a></li><li><a href=https://deepankarm.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://deepankarm.github.io/about/ title=About><span>About</span></a></li><li><a href=https://github.com/deepankarm title=GitHub><span>GitHub</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.linkedin.com/in/deepankar-mahapatro/ title=LinkedIn><span>LinkedIn</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Type-Safe Python Decorators</h1><div class=post-description>A practical guide to getting decorator type hints right with ParamSpec, Concatenate, and generics</div><div class=post-meta><span title='2026-02-01 14:00:00 +0530 +0530'>February 1, 2026</span>&nbsp;·&nbsp;<span>8 min</span>&nbsp;·&nbsp;<span>Deepankar Mahapatro</span></div></header><div class=post-content><p>Decorators are everywhere in Python. Logging, retries, caching, auth checks - if you&rsquo;ve built anything non-trivial, you&rsquo;ve written one. But the moment you try to add type hints, things get weird. Your IDE loses autocomplete. You end up with <code>Callable[..., Any]</code> and pretend the problem doesn&rsquo;t exist, because <code>Callable</code> can&rsquo;t express &ldquo;whatever arguments the wrapped function takes.&rdquo;</p><p><a href=https://peps.python.org/pep-0612/>PEP 612</a> introduced <code>ParamSpec</code> (Python 3.10+) to solve exactly this. This post walks through using it - from trivial cases to the genuinely painful scenarios I hit while building a multi-LLM agent backend. Read the <a href=#tldr>TL;DR</a> section for a quick summary.</p><hr><h2 id=level-1-simple-passthrough-decorator>Level 1: Simple passthrough decorator<a hidden class=anchor aria-hidden=true href=#level-1-simple-passthrough-decorator>#</a></h2><p>The classic timing decorator. It doesn&rsquo;t change arguments or return types - just wraps the call.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>time</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>functools</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>wraps</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>typing</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>Callable</span>, <span style=color:#e06c75>ParamSpec</span>, <span style=color:#e06c75>TypeVar</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>P</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>ParamSpec</span>(<span style=color:#98c379>&#34;P&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#e06c75>R</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>TypeVar</span>(<span style=color:#98c379>&#34;R&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>timeit</span>(<span style=color:#e06c75>func</span>: <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>P</span>, <span style=color:#e06c75>R</span>]) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>P</span>, <span style=color:#e06c75>R</span>]:
</span></span><span style=display:flex><span>    <span style=color:#61afef>@wraps</span>(<span style=color:#e06c75>func</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>wrapper</span>(<span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>kwargs</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>R</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>start</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>time</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>perf_counter</span>()
</span></span><span style=display:flex><span>        <span style=color:#e06c75>result</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>func</span>(<span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>)
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;</span><span style=color:#98c379>{</span><span style=color:#e06c75>func</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>__name__</span><span style=color:#98c379>}</span><span style=color:#98c379> took </span><span style=color:#98c379>{</span><span style=color:#e06c75>time</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>perf_counter</span>() <span style=color:#56b6c2>-</span> <span style=color:#e06c75>start</span><span style=color:#98c379>:</span><span style=color:#98c379>.3f</span><span style=color:#98c379>}</span><span style=color:#98c379>s&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>result</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>wrapper</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#61afef>@timeit</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>fetch_data</span>(<span style=color:#e06c75>url</span>: <span style=color:#e5c07b>str</span>, <span style=color:#e06c75>timeout</span>: <span style=color:#e5c07b>int</span> <span style=color:#56b6c2>=</span> <span style=color:#d19a66>30</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e5c07b>dict</span>[<span style=color:#e5c07b>str</span>, <span style=color:#e5c07b>str</span>]: <span style=color:#56b6c2>...</span>
</span></span></code></pre></div><p><code>ParamSpec("P")</code> captures the entire parameter signature. <code>P.args</code> and <code>P.kwargs</code> are special forms that can only appear together in a function signature. The type checker sees <code>fetch_data</code> as <code>(url: str, timeout: int = 30) -> dict[str, str]</code> - signature fully preserved.</p><hr><h2 id=level-2-decorator-with-arguments>Level 2: Decorator with arguments<a hidden class=anchor aria-hidden=true href=#level-2-decorator-with-arguments>#</a></h2><p><code>@retry(times=3)</code> means <code>retry(times=3)</code> returns the actual decorator. Triple nesting.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>functools</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>wraps</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>typing</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>Callable</span>, <span style=color:#e06c75>ParamSpec</span>, <span style=color:#e06c75>TypeVar</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>P</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>ParamSpec</span>(<span style=color:#98c379>&#34;P&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#e06c75>R</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>TypeVar</span>(<span style=color:#98c379>&#34;R&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>retry</span>(<span style=color:#e06c75>times</span>: <span style=color:#e5c07b>int</span> <span style=color:#56b6c2>=</span> <span style=color:#d19a66>3</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>Callable</span>[[<span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>P</span>, <span style=color:#e06c75>R</span>]], <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>P</span>, <span style=color:#e06c75>R</span>]]:
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>decorator</span>(<span style=color:#e06c75>func</span>: <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>P</span>, <span style=color:#e06c75>R</span>]) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>P</span>, <span style=color:#e06c75>R</span>]:
</span></span><span style=display:flex><span>        <span style=color:#61afef>@wraps</span>(<span style=color:#e06c75>func</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>wrapper</span>(<span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>kwargs</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>R</span>:
</span></span><span style=display:flex><span>            <span style=color:#c678dd>for</span> <span style=color:#e06c75>attempt</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#e06c75>times</span>):
</span></span><span style=display:flex><span>                <span style=color:#c678dd>try</span>:
</span></span><span style=display:flex><span>                    <span style=color:#c678dd>return</span> <span style=color:#e06c75>func</span>(<span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>)
</span></span><span style=display:flex><span>                <span style=color:#c678dd>except</span> <span style=color:#e06c75>Exception</span>:
</span></span><span style=display:flex><span>                    <span style=color:#c678dd>if</span> <span style=color:#e06c75>attempt</span> <span style=color:#56b6c2>==</span> <span style=color:#e06c75>times</span> <span style=color:#56b6c2>-</span> <span style=color:#d19a66>1</span>:
</span></span><span style=display:flex><span>                        <span style=color:#c678dd>raise</span>
</span></span><span style=display:flex><span>            <span style=color:#c678dd>raise</span> <span style=color:#e06c75>RuntimeError</span>(<span style=color:#98c379>&#34;unreachable&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>wrapper</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>decorator</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#61afef>@retry</span>(<span style=color:#e06c75>times</span><span style=color:#56b6c2>=</span><span style=color:#d19a66>5</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>simple</span>(<span style=color:#e06c75>a</span>: <span style=color:#e5c07b>str</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e5c07b>dict</span>[<span style=color:#e5c07b>str</span>, <span style=color:#e5c07b>str</span>]: <span style=color:#56b6c2>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#61afef>@retry</span>(<span style=color:#e06c75>times</span><span style=color:#56b6c2>=</span><span style=color:#d19a66>5</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>complicated</span>(<span style=color:#e06c75>a</span>: <span style=color:#e5c07b>int</span>, <span style=color:#e06c75>b</span>: <span style=color:#e5c07b>int</span>, <span style=color:#e06c75>c</span>: <span style=color:#e5c07b>str</span> <span style=color:#56b6c2>=</span> <span style=color:#98c379>&#34;default&#34;</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e5c07b>int</span>: <span style=color:#56b6c2>...</span>
</span></span></code></pre></div><p>The outer function returns <code>Callable[[Callable[P, R]], Callable[P, R]]</code> - a function that takes a callable and returns one with the same signature. Type checkers handle this well.</p><hr><h2 id=level-3-method-decorators>Level 3: Method decorators<a hidden class=anchor aria-hidden=true href=#level-3-method-decorators>#</a></h2><p><code>ParamSpec</code> captures <code>self</code> automatically. The same <code>timeit</code> decorator from Level 1 works on methods without changes.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>time</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>functools</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>wraps</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>typing</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>Callable</span>, <span style=color:#e06c75>ParamSpec</span>, <span style=color:#e06c75>TypeVar</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>P</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>ParamSpec</span>(<span style=color:#98c379>&#34;P&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#e06c75>R</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>TypeVar</span>(<span style=color:#98c379>&#34;R&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>timeit</span>(<span style=color:#e06c75>func</span>: <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>P</span>, <span style=color:#e06c75>R</span>]) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>P</span>, <span style=color:#e06c75>R</span>]:
</span></span><span style=display:flex><span>    <span style=color:#61afef>@wraps</span>(<span style=color:#e06c75>func</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>wrapper</span>(<span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>kwargs</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>R</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>start</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>time</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>perf_counter</span>()
</span></span><span style=display:flex><span>        <span style=color:#e06c75>result</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>func</span>(<span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>)
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>print</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;</span><span style=color:#98c379>{</span><span style=color:#e06c75>func</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>__name__</span><span style=color:#98c379>}</span><span style=color:#98c379> took </span><span style=color:#98c379>{</span><span style=color:#e06c75>time</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>perf_counter</span>() <span style=color:#56b6c2>-</span> <span style=color:#e06c75>start</span><span style=color:#98c379>:</span><span style=color:#98c379>.3f</span><span style=color:#98c379>}</span><span style=color:#98c379>s&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>result</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>wrapper</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>UserService</span>:
</span></span><span style=display:flex><span>    <span style=color:#61afef>@timeit</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>get_user</span>(<span style=color:#e5c07b>self</span>, <span style=color:#e06c75>user_id</span>: <span style=color:#e5c07b>int</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e5c07b>dict</span>[<span style=color:#e5c07b>str</span>, <span style=color:#e5c07b>int</span>]: <span style=color:#56b6c2>...</span>
</span></span></code></pre></div><p><code>P</code> captures <code>(self: UserService, user_id: int)</code>. The type checker is happy, <code>self.get_user(42)</code> has correct autocomplete. No special handling needed.</p><p>But this breaks when the decorator needs to <em>access</em> <code>self</code>.</p><hr><h2 id=level-4-decorators-that-access-self>Level 4: Decorators that access <code>self</code><a hidden class=anchor aria-hidden=true href=#level-4-decorators-that-access-self>#</a></h2><p>If the decorator body needs <code>self</code> - for logging via <code>self.logger</code>, checking <code>self.config</code>, etc. - you need <code>Concatenate</code>.</p><p>The problem: <code>P</code> is atomic. You can&rsquo;t decompose it to &ldquo;pull out the first argument.&rdquo; <code>typing.Concatenate</code> solves this by letting you prepend specific types to a <code>ParamSpec</code>:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#e06c75>logging</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>functools</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>wraps</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>typing</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>Callable</span>, <span style=color:#e06c75>Concatenate</span>, <span style=color:#e06c75>ParamSpec</span>, <span style=color:#e06c75>TypeVar</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>P</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>ParamSpec</span>(<span style=color:#98c379>&#34;P&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#e06c75>R</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>TypeVar</span>(<span style=color:#98c379>&#34;R&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>Service</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>logger</span>: <span style=color:#e06c75>logging</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>Logger</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>SelfT</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>TypeVar</span>(<span style=color:#98c379>&#34;SelfT&#34;</span>, <span style=color:#e06c75>bound</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>Service</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>with_logging</span>(
</span></span><span style=display:flex><span>    <span style=color:#e06c75>func</span>: <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>Concatenate</span>[<span style=color:#e06c75>SelfT</span>, <span style=color:#e06c75>P</span>], <span style=color:#e06c75>R</span>],
</span></span><span style=display:flex><span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>Concatenate</span>[<span style=color:#e06c75>SelfT</span>, <span style=color:#e06c75>P</span>], <span style=color:#e06c75>R</span>]:
</span></span><span style=display:flex><span>    <span style=color:#61afef>@wraps</span>(<span style=color:#e06c75>func</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>wrapper</span>(<span style=color:#e5c07b>self</span>: <span style=color:#e06c75>SelfT</span>, <span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>kwargs</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>R</span>:
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>self</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>logger</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>info</span>(<span style=color:#98c379>f</span><span style=color:#98c379>&#34;Calling </span><span style=color:#98c379>{</span><span style=color:#e06c75>func</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>__name__</span><span style=color:#98c379>}</span><span style=color:#98c379>&#34;</span>)  <span style=color:#7f848e># self is typed as SelfT</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>func</span>(<span style=color:#e5c07b>self</span>, <span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>wrapper</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>UserService</span>(<span style=color:#e06c75>Service</span>):
</span></span><span style=display:flex><span>    <span style=color:#61afef>@with_logging</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>get_user</span>(<span style=color:#e5c07b>self</span>, <span style=color:#e06c75>user_id</span>: <span style=color:#e5c07b>int</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e5c07b>dict</span>[<span style=color:#e5c07b>str</span>, <span style=color:#e5c07b>int</span>]: <span style=color:#56b6c2>...</span>
</span></span></code></pre></div><p>Mental model for <code>Concatenate</code>:</p><pre tabindex=0><code>Original:  def get_user(self, user_id: int) -&gt; dict[str, int]
                        ^^^^  ^^^^^^^^^^^^
Concatenate[SelfT, P] matches as:
  SelfT = UserService (bound to Service)
  P     = (user_id: int)
</code></pre><p><code>Concatenate</code> prepends <code>SelfT</code> to <code>P</code>, so the full signature is reconstructed as <code>(self: SelfT, *P.args, **P.kwargs)</code>. The decorator can use <code>self.logger</code> because <code>SelfT</code> is bound to <code>Service</code>.</p><hr><h2 id=level-5-when-the-base-class-isnt-enough>Level 5: When the base class isn&rsquo;t enough<a hidden class=anchor aria-hidden=true href=#level-5-when-the-base-class-isnt-enough>#</a></h2><p>Here&rsquo;s where things get interesting. Consider an agent backend where:</p><ul><li><code>Agent[T]</code> is a generic base class - <code>T</code> is the structured output type</li><li>Agents gain capabilities through mixins: <code>ObservabilityMixin</code> provides <code>self.record_cost()</code>, <code>MemoryMixin</code> provides <code>self.history</code></li><li>Not every agent has every mixin. <code>SummarisationAgent</code> has cost tracking but no memory. <code>ChatAgent</code> has both.</li><li>Decorators need access to <code>self</code>, but each decorator needs attributes from a <em>different</em> mixin</li></ul><p>The naive approach - <code>AgentT = TypeVar("AgentT", bound="Agent[Any]")</code> for every decorator - breaks immediately. <code>Agent</code> doesn&rsquo;t have <code>record_cost()</code>. You could dump every attribute onto the base class, but that defeats the purpose of mixins.</p><p>The solution: each decorator declares a <code>Protocol</code> for the <code>self</code> it needs, and binds its TypeVar to that Protocol. <code>@track_cost</code> requires <code>HasObservability</code>. <code>@inject_history</code> requires <code>HasMemory</code>. <code>@validate_output</code> only needs the base <code>Agent</code>.</p><p>The type checker then enforces correctness at the decorator application site. Slapping <code>@inject_history</code> on a <code>SummarisationAgent</code> (which lacks <code>MemoryMixin</code>) is a type error - exactly the bug you want caught at dev time, not when <code>self.history</code> blows up in production.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>abc</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>ABC</span>, <span style=color:#e06c75>abstractmethod</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>dataclasses</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>dataclass</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>functools</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>wraps</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>from</span> <span style=color:#e06c75>typing</span> <span style=color:#c678dd>import</span> <span style=color:#e06c75>Any</span>, <span style=color:#e06c75>Callable</span>, <span style=color:#e06c75>Concatenate</span>, <span style=color:#e06c75>Generic</span>, <span style=color:#e06c75>ParamSpec</span>, <span style=color:#e06c75>Protocol</span>, <span style=color:#e06c75>TypeVar</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e># Single set of type variables - shared across all decorators</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>P</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>ParamSpec</span>(<span style=color:#98c379>&#34;P&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#e06c75>R</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>TypeVar</span>(<span style=color:#98c379>&#34;R&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#e06c75>T</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>TypeVar</span>(<span style=color:#98c379>&#34;T&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#61afef>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>Summary</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>condensed</span>: <span style=color:#e5c07b>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#61afef>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>ChatResponse</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>reply</span>: <span style=color:#e5c07b>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>LLMClient</span>: <span style=color:#56b6c2>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>ObservabilityMixin</span>:
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>record_cost</span>(<span style=color:#e5c07b>self</span>, <span style=color:#e06c75>tokens</span>: <span style=color:#e5c07b>int</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e5c07b>None</span>: <span style=color:#56b6c2>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>MemoryMixin</span>:
</span></span><span style=display:flex><span>    <span style=color:#e06c75>history</span>: <span style=color:#e5c07b>list</span>[<span style=color:#e5c07b>dict</span>[<span style=color:#e5c07b>str</span>, <span style=color:#e5c07b>str</span>]] <span style=color:#56b6c2>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>HasObservability</span>(<span style=color:#e06c75>Protocol</span>):
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>record_cost</span>(<span style=color:#e5c07b>self</span>, <span style=color:#e06c75>tokens</span>: <span style=color:#e5c07b>int</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e5c07b>None</span>: <span style=color:#56b6c2>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>HasMemory</span>(<span style=color:#e06c75>Protocol</span>):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>history</span>: <span style=color:#e5c07b>list</span>[<span style=color:#e5c07b>dict</span>[<span style=color:#e5c07b>str</span>, <span style=color:#e5c07b>str</span>]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e># TypeVars bound to protocols - not to the base class</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>ObservableT</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>TypeVar</span>(<span style=color:#98c379>&#34;ObservableT&#34;</span>, <span style=color:#e06c75>bound</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>HasObservability</span>)
</span></span><span style=display:flex><span><span style=color:#e06c75>MemoryAwareT</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>TypeVar</span>(<span style=color:#98c379>&#34;MemoryAwareT&#34;</span>, <span style=color:#e06c75>bound</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>HasMemory</span>)
</span></span><span style=display:flex><span><span style=color:#e06c75>AgentT</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>TypeVar</span>(<span style=color:#98c379>&#34;AgentT&#34;</span>, <span style=color:#e06c75>bound</span><span style=color:#56b6c2>=</span><span style=color:#98c379>&#34;Agent[Any]&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>track_cost</span>(
</span></span><span style=display:flex><span>    <span style=color:#e06c75>func</span>: <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>Concatenate</span>[<span style=color:#e06c75>ObservableT</span>, <span style=color:#e06c75>P</span>], <span style=color:#e06c75>R</span>],
</span></span><span style=display:flex><span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>Concatenate</span>[<span style=color:#e06c75>ObservableT</span>, <span style=color:#e06c75>P</span>], <span style=color:#e06c75>R</span>]:
</span></span><span style=display:flex><span>    <span style=color:#98c379>&#34;&#34;&#34;Record token usage via self.record_cost. Works on any agent with ObservabilityMixin.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#61afef>@wraps</span>(<span style=color:#e06c75>func</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>wrapper</span>(<span style=color:#e5c07b>self</span>: <span style=color:#e06c75>ObservableT</span>, <span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>kwargs</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>R</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>result</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>func</span>(<span style=color:#e5c07b>self</span>, <span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>)
</span></span><span style=display:flex><span>        <span style=color:#e5c07b>self</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>record_cost</span>(<span style=color:#e06c75>tokens</span><span style=color:#56b6c2>=</span><span style=color:#d19a66>42</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>result</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>wrapper</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>inject_history</span>(
</span></span><span style=display:flex><span>    <span style=color:#e06c75>func</span>: <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>Concatenate</span>[<span style=color:#e06c75>MemoryAwareT</span>, <span style=color:#e06c75>P</span>], <span style=color:#e06c75>R</span>],
</span></span><span style=display:flex><span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>Concatenate</span>[<span style=color:#e06c75>MemoryAwareT</span>, <span style=color:#e06c75>P</span>], <span style=color:#e06c75>R</span>]:
</span></span><span style=display:flex><span>    <span style=color:#98c379>&#34;&#34;&#34;Prepend conversation history. Only works on agents with MemoryMixin.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#61afef>@wraps</span>(<span style=color:#e06c75>func</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>wrapper</span>(<span style=color:#e5c07b>self</span>: <span style=color:#e06c75>MemoryAwareT</span>, <span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>kwargs</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>R</span>:
</span></span><span style=display:flex><span>        <span style=color:#7f848e># decorator reads self.history - only available via MemoryMixin</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>_</span> <span style=color:#56b6c2>=</span> <span style=color:#e5c07b>self</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>history</span>
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>func</span>(<span style=color:#e5c07b>self</span>, <span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>wrapper</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>validate_output</span>(
</span></span><span style=display:flex><span>    <span style=color:#e06c75>func</span>: <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>Concatenate</span>[<span style=color:#e06c75>AgentT</span>, <span style=color:#e06c75>P</span>], <span style=color:#e06c75>R</span>],
</span></span><span style=display:flex><span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>Callable</span>[<span style=color:#e06c75>Concatenate</span>[<span style=color:#e06c75>AgentT</span>, <span style=color:#e06c75>P</span>], <span style=color:#e06c75>R</span>]:
</span></span><span style=display:flex><span>    <span style=color:#98c379>&#34;&#34;&#34;Retry on malformed output. Only needs base Agent attributes.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#61afef>@wraps</span>(<span style=color:#e06c75>func</span>)
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>wrapper</span>(<span style=color:#e5c07b>self</span>: <span style=color:#e06c75>AgentT</span>, <span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>: <span style=color:#e06c75>P</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>kwargs</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>R</span>:
</span></span><span style=display:flex><span>        <span style=color:#e06c75>result</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>func</span>(<span style=color:#e5c07b>self</span>, <span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>for</span> <span style=color:#e06c75>_</span> <span style=color:#56b6c2>in</span> <span style=color:#e5c07b>range</span>(<span style=color:#e5c07b>self</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>max_validation_retries</span> <span style=color:#56b6c2>-</span> <span style=color:#d19a66>1</span>):
</span></span><span style=display:flex><span>            <span style=color:#c678dd>if</span> <span style=color:#e5c07b>self</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>is_valid</span>(<span style=color:#e06c75>result</span>):
</span></span><span style=display:flex><span>                <span style=color:#c678dd>return</span> <span style=color:#e06c75>result</span>
</span></span><span style=display:flex><span>            <span style=color:#e06c75>result</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>func</span>(<span style=color:#e5c07b>self</span>, <span style=color:#56b6c2>*</span><span style=color:#e06c75>args</span>, <span style=color:#56b6c2>**</span><span style=color:#e06c75>kwargs</span>)
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>result</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>return</span> <span style=color:#e06c75>wrapper</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>Agent</span>(<span style=color:#e06c75>ABC</span>, <span style=color:#e06c75>Generic</span>[<span style=color:#e06c75>T</span>]):
</span></span><span style=display:flex><span>    <span style=color:#e06c75>llm</span>: <span style=color:#e06c75>LLMClient</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>max_validation_retries</span>: <span style=color:#e5c07b>int</span> <span style=color:#56b6c2>=</span> <span style=color:#d19a66>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>is_valid</span>(<span style=color:#e5c07b>self</span>, <span style=color:#e06c75>result</span>: <span style=color:#e06c75>Any</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e5c07b>bool</span>: <span style=color:#56b6c2>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#61afef>@abstractmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>run</span>(<span style=color:#e5c07b>self</span>, <span style=color:#e06c75>prompt</span>: <span style=color:#e5c07b>str</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>T</span>: <span style=color:#56b6c2>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>SummarisationAgent</span>(<span style=color:#e06c75>ObservabilityMixin</span>, <span style=color:#e06c75>Agent</span>[<span style=color:#e06c75>Summary</span>]):
</span></span><span style=display:flex><span>    <span style=color:#98c379>&#34;&#34;&#34;Has cost tracking (ObservabilityMixin), but no memory.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#61afef>@track_cost</span>  <span style=color:#7f848e># ✅ Has ObservabilityMixin → satisfies HasObservability</span>
</span></span><span style=display:flex><span>    <span style=color:#61afef>@validate_output</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>run</span>(<span style=color:#e5c07b>self</span>, <span style=color:#e06c75>prompt</span>: <span style=color:#e5c07b>str</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>Summary</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>Summary</span>(<span style=color:#e06c75>condensed</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>prompt</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>ChatAgent</span>(<span style=color:#e06c75>ObservabilityMixin</span>, <span style=color:#e06c75>MemoryMixin</span>, <span style=color:#e06c75>Agent</span>[<span style=color:#e06c75>ChatResponse</span>]):
</span></span><span style=display:flex><span>    <span style=color:#98c379>&#34;&#34;&#34;Has both cost tracking and conversation memory.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#61afef>@track_cost</span>  <span style=color:#7f848e># ✅ Has ObservabilityMixin → satisfies HasObservability</span>
</span></span><span style=display:flex><span>    <span style=color:#61afef>@inject_history</span>  <span style=color:#7f848e># ✅ Has MemoryMixin → satisfies HasMemory</span>
</span></span><span style=display:flex><span>    <span style=color:#61afef>@validate_output</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>run</span>(<span style=color:#e5c07b>self</span>, <span style=color:#e06c75>prompt</span>: <span style=color:#e5c07b>str</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>ChatResponse</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>ChatResponse</span>(<span style=color:#e06c75>reply</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>prompt</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>AgentWithoutMemory</span>(<span style=color:#e06c75>Agent</span>[<span style=color:#e06c75>Summary</span>]):
</span></span><span style=display:flex><span>    <span style=color:#98c379>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#98c379>    ❌ Type error
</span></span></span><span style=display:flex><span><span style=color:#98c379>    Argument of type &#34;(self: Self@AgentWithoutMemory, prompt: str) -&gt; Summary&#34; cannot be assigned to parameter &#34;func&#34; of type &#34;(MemoryAwareT@inject_history, **P@inject_history) -&gt; R@inject_history&#34; in function &#34;inject_history&#34;
</span></span></span><span style=display:flex><span><span style=color:#98c379>    Type &#34;(self: Self@AgentWithoutMemory, prompt: str) -&gt; Summary&#34; is not assignable to type &#34;(MemoryAwareT@inject_history, **P@inject_history) -&gt; R@inject_history&#34;
</span></span></span><span style=display:flex><span><span style=color:#98c379>      Parameter 1: type &#34;MemoryAwareT@inject_history&#34; is incompatible with type &#34;Self@AgentWithoutMemory&#34;
</span></span></span><span style=display:flex><span><span style=color:#98c379>        &#34;HasMemory*&#34; is not assignable to &#34;AgentWithoutMemory&#34;basedpyrightreportArgumentType
</span></span></span><span style=display:flex><span><span style=color:#98c379>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#61afef>@inject_history</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>def</span> <span style=color:#61afef;font-weight:700>run</span>(<span style=color:#e5c07b>self</span>, <span style=color:#e06c75>prompt</span>: <span style=color:#e5c07b>str</span>) <span style=color:#56b6c2>-&gt;</span> <span style=color:#e06c75>Summary</span>:
</span></span><span style=display:flex><span>        <span style=color:#c678dd>return</span> <span style=color:#e06c75>Summary</span>(<span style=color:#e06c75>condensed</span><span style=color:#56b6c2>=</span><span style=color:#e06c75>prompt</span>)
</span></span></code></pre></div><p><code>SummarisationAgent</code> uses <code>@track_cost</code> and <code>@validate_output</code> - it has <code>ObservabilityMixin</code> so it satisfies <code>HasObservability</code>, and it extends <code>Agent</code> so it satisfies the base bound. <code>ChatAgent</code> additionally uses <code>@inject_history</code> because it has <code>MemoryMixin</code>. <code>AgentWithoutMemory</code> at the bottom shows what happens when you get it wrong - pyright rejects it because <code>Agent[Summary]</code> alone doesn&rsquo;t satisfy the <code>HasMemory</code> protocol.</p><hr><h2 id=common-pitfalls>Common pitfalls<a hidden class=anchor aria-hidden=true href=#common-pitfalls>#</a></h2><ul><li><strong>TypeVar shadowing across modules:</strong> If decorators in different modules each define their own <code>R = TypeVar("R")</code>, the type checker may fail to unify them when stacked. Define a single set of TypeVars in one module and import everywhere.</li><li><strong>Stacking order breaks when return types change:</strong> If all decorators have identical signatures (<code>Callable[Concatenate[AgentT, P], R] -> Callable[Concatenate[AgentT, P], R]</code>), order doesn&rsquo;t matter. If one changes the return type (wrapping in <code>Result[R]</code>), the next decorator sees a different <code>R</code>. Debug with <code>reveal_type()</code> - a special form recognized by mypy/pyright that prints the inferred type during checking (not a runtime function).</li><li><strong><code>P.kwargs</code> is opaque to the type checker:</strong> At runtime, <code>kwargs</code> is a normal mutable dict. But the type checker won&rsquo;t let you treat <code>P.kwargs</code> as <code>dict[str, Any]</code> - you can&rsquo;t call <code>kwargs.setdefault()</code> or index into it without a type error. The type system treats <code>ParamSpec</code> kwargs as a sealed contract. Add defaults in the function signature itself, or use <code>cast</code>.</li><li><strong><code>@functools.wraps</code> doesn&rsquo;t affect types:</strong> It copies runtime metadata (<code>__name__</code>, <code>__doc__</code>), but the type annotations on your wrapper function are what the type checker sees. Use <code>@wraps</code> for introspection, rely on annotations for correctness.</li></ul><hr><h2 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><table><thead><tr><th>Scenario</th><th>Pattern</th></tr></thead><tbody><tr><td>Simple passthrough</td><td><code>Callable[P, R] -> Callable[P, R]</code></td></tr><tr><td>Decorator with arguments</td><td>Outer returns <code>Callable[[Callable[P, R]], Callable[P, R]]</code> - triple nesting</td></tr><tr><td>Decorator accesses <code>self</code></td><td><code>Concatenate[SelfT, P]</code> with <code>SelfT</code> bound to the base class</td></tr><tr><td>Decorator accesses mixin state</td><td><code>Protocol</code> per decorator, bind <code>SelfT</code> to the protocol instead of the base class</td></tr><tr><td>Stacking decorators</td><td>Keep signatures identical across all decorators. Share TypeVars at module level</td></tr></tbody></table><p>What other decorator typing issues have you run into? I&rsquo;m curious what I&rsquo;ve missed.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://deepankarm.github.io/tags/python/>python</a></li><li><a href=https://deepankarm.github.io/tags/type-hints/>type hints</a></li><li><a href=https://deepankarm.github.io/tags/decorators/>decorators</a></li><li><a href=https://deepankarm.github.io/tags/paramspec/>ParamSpec</a></li><li><a href=https://deepankarm.github.io/tags/mypy/>mypy</a></li><li><a href=https://deepankarm.github.io/tags/pyright/>pyright</a></li></ul><nav class=paginav><a class=next href=https://deepankarm.github.io/posts/claude-code-hooks-for-slack/><span class=title>Next »</span><br><span>Claude Code hooks for Slack</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://deepankarm.github.io/>deepankar.log</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>